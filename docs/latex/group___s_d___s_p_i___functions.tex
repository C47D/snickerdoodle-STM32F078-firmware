\hypertarget{group___s_d___s_p_i___functions}{}\section{S\+PI Functions}
\label{group___s_d___s_p_i___functions}\index{S\+P\+I Functions@{S\+P\+I Functions}}
\subsection*{Modules}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{group___s_d___s_p_i___private___functions}{S\+P\+I Private Functions}}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{group___s_d___s_p_i___functions_ga8118d57f7a1dacd85c82cf695fe595a0}\label{group___s_d___s_p_i___functions_ga8118d57f7a1dacd85c82cf695fe595a0}} 
void {\bfseries sd\+\_\+spi2\+\_\+init} (void)
\item 
void \mbox{\hyperlink{group___s_d___s_p_i___functions_ga17f583be14b22caffa6c4e56dcd035ef}{H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+Init}} (S\+P\+I\+\_\+\+Handle\+Type\+Def $\ast$hspi)
\item 
void \mbox{\hyperlink{group___s_d___s_p_i___functions_gabadc4d4974af1afd943e8d13589068e1}{H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+De\+Init}} (S\+P\+I\+\_\+\+Handle\+Type\+Def $\ast$hspi)
\item 
enum \mbox{\hyperlink{group___s_d___s_p_i___types_ga9ae67f7089a8196e9c6b74b8a6708c2e}{sd\+\_\+spi\+\_\+error}} \mbox{\hyperlink{group___s_d___s_p_i___functions_gaf4898042003aea6ba58eb519eb115284}{sd\+\_\+spi\+\_\+dev\+\_\+init}} (struct \mbox{\hyperlink{structsd__spi__dev}{sd\+\_\+spi\+\_\+dev}} $\ast$dev, S\+P\+I\+\_\+\+Handle\+Type\+Def $\ast$spi)
\begin{DoxyCompactList}\small\item\em S\+PI Device Initialization Initialize S\+PI device structure. \end{DoxyCompactList}\item 
enum \mbox{\hyperlink{group___s_d___s_p_i___types_ga9ae67f7089a8196e9c6b74b8a6708c2e}{sd\+\_\+spi\+\_\+error}} \mbox{\hyperlink{group___s_d___s_p_i___functions_gad3e4aa819e8e76a92816be83ca2702c9}{sd\+\_\+spi\+\_\+rx\+\_\+init}} (struct \mbox{\hyperlink{structsd__spi__dev}{sd\+\_\+spi\+\_\+dev}} $\ast$dev, struct \mbox{\hyperlink{structsd__cbuf}{sd\+\_\+cbuf}} $\ast$rx\+\_\+buff)
\begin{DoxyCompactList}\small\item\em S\+PI Receive Interrupt Initialization Enable and prepare the S\+PI to receive on interrupt. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{group___s_d___s_p_i___functions_ga091c2e241f814bec60a92c7f97eb89ae}{sd\+\_\+spi\+\_\+irqhandler}} (struct \mbox{\hyperlink{structsd__spi__dev}{sd\+\_\+spi\+\_\+dev}} $\ast$dev)
\begin{DoxyCompactList}\small\item\em S\+PI Interrupt Handler Handle interrupt events on the spi peripheral. \end{DoxyCompactList}\item 
static enum \mbox{\hyperlink{group___s_d___s_p_i___types_ga9ae67f7089a8196e9c6b74b8a6708c2e}{sd\+\_\+spi\+\_\+error}} \mbox{\hyperlink{group___s_d___s_p_i___functions_ga8f8403c9f68c9a623486a29cf8715fda}{sd\+\_\+spi\+\_\+rx\+\_\+isr}} (struct \mbox{\hyperlink{structsd__spi__dev}{sd\+\_\+spi\+\_\+dev}} $\ast$dev)
\begin{DoxyCompactList}\small\item\em Receive an amount of data in interrupt mode. \end{DoxyCompactList}\item 
static void \mbox{\hyperlink{group___s_d___s_p_i___functions_ga3515d67aa70e65e562b55011aface3b9}{sd\+\_\+spi\+\_\+error\+\_\+cb}} (struct \mbox{\hyperlink{structsd__spi__dev}{sd\+\_\+spi\+\_\+dev}} $\ast$dev)
\begin{DoxyCompactList}\small\item\em Handle S\+PI error interrupts. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}


\subsection{Function Documentation}
\mbox{\Hypertarget{group___s_d___s_p_i___functions_gabadc4d4974af1afd943e8d13589068e1}\label{group___s_d___s_p_i___functions_gabadc4d4974af1afd943e8d13589068e1}} 
\index{S\+P\+I Functions@{S\+P\+I Functions}!H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+De\+Init@{H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+De\+Init}}
\index{H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+De\+Init@{H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+De\+Init}!S\+P\+I Functions@{S\+P\+I Functions}}
\subsubsection{\texorpdfstring{H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+De\+Init()}{HAL\_SPI\_MspDeInit()}}
{\footnotesize\ttfamily void H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+De\+Init (\begin{DoxyParamCaption}\item[{S\+P\+I\+\_\+\+Handle\+Type\+Def $\ast$}]{hspi }\end{DoxyParamCaption})}



{\ttfamily \#include $<$\mbox{\hyperlink{sd__spi_8c}{Src/sd\+\_\+spi.\+c}}$>$}

S\+P\+I2 G\+P\+IO Configuration ~\newline
P\+B15 -\/-\/-\/---$>$ S\+P\+I2\+\_\+\+M\+O\+SI P\+B14 -\/-\/-\/---$>$ S\+P\+I2\+\_\+\+M\+I\+SO P\+B13 -\/-\/-\/---$>$ S\+P\+I2\+\_\+\+S\+CK P\+B12 -\/-\/-\/---$>$ S\+P\+I2\+\_\+\+N\+SS
\begin{DoxyCode}
145 \{
146     \textcolor{keywordflow}{if} (hspi->Instance==SPI2) \{
147         \textcolor{comment}{/* Peripheral clock disable */}
148         \_\_SPI2\_CLK\_DISABLE();
149   
157         HAL\_GPIO\_DeInit(GPIOB, ZYNQ\_SPI\_MOSI\_Pin|ZYNQ\_SPI\_MISO\_Pin|ZYNQ\_SPI\_CLK\_Pin|ZYNQ\_SPI\_NSS\_Pin);
158 
159         \textcolor{comment}{/* Peripheral interrupt Deinit*/}
160         HAL\_NVIC\_DisableIRQ(SPI2\_IRQn);
161 
162     \}
163 \} 
\end{DoxyCode}
\mbox{\Hypertarget{group___s_d___s_p_i___functions_ga17f583be14b22caffa6c4e56dcd035ef}\label{group___s_d___s_p_i___functions_ga17f583be14b22caffa6c4e56dcd035ef}} 
\index{S\+P\+I Functions@{S\+P\+I Functions}!H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+Init@{H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+Init}}
\index{H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+Init@{H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+Init}!S\+P\+I Functions@{S\+P\+I Functions}}
\subsubsection{\texorpdfstring{H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+Init()}{HAL\_SPI\_MspInit()}}
{\footnotesize\ttfamily void H\+A\+L\+\_\+\+S\+P\+I\+\_\+\+Msp\+Init (\begin{DoxyParamCaption}\item[{S\+P\+I\+\_\+\+Handle\+Type\+Def $\ast$}]{hspi }\end{DoxyParamCaption})}



{\ttfamily \#include $<$\mbox{\hyperlink{sd__spi_8c}{Src/sd\+\_\+spi.\+c}}$>$}

\paragraph*{S\+P\+I2 G\+P\+IO Configuration}

P\+B15 -\/-\/-\/---$>$ S\+P\+I2\+\_\+\+M\+O\+SI P\+B14 -\/-\/-\/---$>$ S\+P\+I2\+\_\+\+M\+I\+SO P\+B13 -\/-\/-\/---$>$ S\+P\+I2\+\_\+\+S\+CK P\+B12 -\/-\/-\/---$>$ S\+P\+I2\+\_\+\+N\+SS
\begin{DoxyCode}
117 \{
118     GPIO\_InitTypeDef GPIO\_InitStruct;
119     
120     \textcolor{keywordflow}{if} (hspi->Instance==SPI2) \{
121         \textcolor{comment}{/* Peripheral clock enable */}
122         \_\_SPI2\_CLK\_ENABLE();
123   
131         GPIO\_InitStruct.Pin = ZYNQ\_SPI\_MOSI\_Pin|ZYNQ\_SPI\_MISO\_Pin|ZYNQ\_SPI\_CLK\_Pin|ZYNQ\_SPI\_NSS\_Pin;
132         GPIO\_InitStruct.Mode = GPIO\_MODE\_AF\_PP;
133         GPIO\_InitStruct.Pull = GPIO\_NOPULL;
134         GPIO\_InitStruct.Speed = GPIO\_SPEED\_HIGH;
135         GPIO\_InitStruct.Alternate = GPIO\_AF0\_SPI2;
136         HAL\_GPIO\_Init(GPIOB, &GPIO\_InitStruct);
137 
138         \textcolor{comment}{/* Peripheral interrupt init*/}
139         HAL\_NVIC\_SetPriority(SPI2\_IRQn, 0, 0);
140         HAL\_NVIC\_EnableIRQ(SPI2\_IRQn);
141     \}
142 \}
\end{DoxyCode}
\mbox{\Hypertarget{group___s_d___s_p_i___functions_gaf4898042003aea6ba58eb519eb115284}\label{group___s_d___s_p_i___functions_gaf4898042003aea6ba58eb519eb115284}} 
\index{S\+P\+I Functions@{S\+P\+I Functions}!sd\+\_\+spi\+\_\+dev\+\_\+init@{sd\+\_\+spi\+\_\+dev\+\_\+init}}
\index{sd\+\_\+spi\+\_\+dev\+\_\+init@{sd\+\_\+spi\+\_\+dev\+\_\+init}!S\+P\+I Functions@{S\+P\+I Functions}}
\subsubsection{\texorpdfstring{sd\+\_\+spi\+\_\+dev\+\_\+init()}{sd\_spi\_dev\_init()}}
{\footnotesize\ttfamily enum \mbox{\hyperlink{group___s_d___s_p_i___types_ga9ae67f7089a8196e9c6b74b8a6708c2e}{sd\+\_\+spi\+\_\+error}} sd\+\_\+spi\+\_\+dev\+\_\+init (\begin{DoxyParamCaption}\item[{struct \mbox{\hyperlink{structsd__spi__dev}{sd\+\_\+spi\+\_\+dev}} $\ast$}]{dev,  }\item[{S\+P\+I\+\_\+\+Handle\+Type\+Def $\ast$}]{spi }\end{DoxyParamCaption})}



{\ttfamily \#include $<$\mbox{\hyperlink{sd__spi_8c}{Src/sd\+\_\+spi.\+c}}$>$}



S\+PI Device Initialization Initialize S\+PI device structure. 


\begin{DoxyParams}{Parameters}
{\em spi\+\_\+dev} & Device structure to initialize \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em S\+D\+\_\+\+S\+P\+I\+\_\+\+S\+U\+C\+C\+E\+SS} & on success, error state otherwise \\
\hline
\end{DoxyRetVals}

\begin{DoxyCode}
175 \{
176     \textcolor{comment}{/* Reset the UART device structure */}
177     memset(dev, 0, \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} \mbox{\hyperlink{structsd__spi__dev}{sd\_spi\_dev}}));
178     
179     dev->\mbox{\hyperlink{structsd__spi__dev_a06909907ded69cbc00db1f401a90f8ee}{spi}} = spi;
180   
181     \textcolor{keywordflow}{return} \mbox{\hyperlink{group___s_d___s_p_i___types_gga9ae67f7089a8196e9c6b74b8a6708c2ea109567296b93a03b1949407009750681}{SD\_SPI\_SUCCESS}};
182 \}
\end{DoxyCode}
\mbox{\Hypertarget{group___s_d___s_p_i___functions_ga3515d67aa70e65e562b55011aface3b9}\label{group___s_d___s_p_i___functions_ga3515d67aa70e65e562b55011aface3b9}} 
\index{S\+P\+I Functions@{S\+P\+I Functions}!sd\+\_\+spi\+\_\+error\+\_\+cb@{sd\+\_\+spi\+\_\+error\+\_\+cb}}
\index{sd\+\_\+spi\+\_\+error\+\_\+cb@{sd\+\_\+spi\+\_\+error\+\_\+cb}!S\+P\+I Functions@{S\+P\+I Functions}}
\subsubsection{\texorpdfstring{sd\+\_\+spi\+\_\+error\+\_\+cb()}{sd\_spi\_error\_cb()}}
{\footnotesize\ttfamily static void sd\+\_\+spi\+\_\+error\+\_\+cb (\begin{DoxyParamCaption}\item[{struct \mbox{\hyperlink{structsd__spi__dev}{sd\+\_\+spi\+\_\+dev}} $\ast$}]{dev }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [static]}}



{\ttfamily \#include $<$\mbox{\hyperlink{sd__spi_8c}{Src/sd\+\_\+spi.\+c}}$>$}



Handle S\+PI error interrupts. 


\begin{DoxyParams}{Parameters}
{\em spi} & S\+PI handle with error triggered error interrupt \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em none} & \\
\hline
\end{DoxyRetVals}

\begin{DoxyCode}
384 \{
385   \textcolor{comment}{/* Handle errors */}
386 \}
\end{DoxyCode}
\mbox{\Hypertarget{group___s_d___s_p_i___functions_ga091c2e241f814bec60a92c7f97eb89ae}\label{group___s_d___s_p_i___functions_ga091c2e241f814bec60a92c7f97eb89ae}} 
\index{S\+P\+I Functions@{S\+P\+I Functions}!sd\+\_\+spi\+\_\+irqhandler@{sd\+\_\+spi\+\_\+irqhandler}}
\index{sd\+\_\+spi\+\_\+irqhandler@{sd\+\_\+spi\+\_\+irqhandler}!S\+P\+I Functions@{S\+P\+I Functions}}
\subsubsection{\texorpdfstring{sd\+\_\+spi\+\_\+irqhandler()}{sd\_spi\_irqhandler()}}
{\footnotesize\ttfamily void sd\+\_\+spi\+\_\+irqhandler (\begin{DoxyParamCaption}\item[{struct \mbox{\hyperlink{structsd__spi__dev}{sd\+\_\+spi\+\_\+dev}} $\ast$}]{dev }\end{DoxyParamCaption})}



{\ttfamily \#include $<$\mbox{\hyperlink{sd__spi_8c}{Src/sd\+\_\+spi.\+c}}$>$}



S\+PI Interrupt Handler Handle interrupt events on the spi peripheral. 


\begin{DoxyParams}{Parameters}
{\em spi\+\_\+dev} & S\+PI device that triggered the interrupt \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em none} & \\
\hline
\end{DoxyRetVals}

\begin{DoxyCode}
262 \{
263     SPI\_HandleTypeDef *spi = dev->\mbox{\hyperlink{structsd__spi__dev_a06909907ded69cbc00db1f401a90f8ee}{spi}};
264 
265     uint32\_t itsource = spi->Instance->CR2;
266     uint32\_t itflag   = spi->Instance->SR;
267 
268     \textcolor{comment}{/*---------------------- SPI in mode Receiver ------------------------*/}
269     \textcolor{keywordflow}{if} (((itflag & SPI\_FLAG\_OVR) == RESET) &&
270         ((itflag & SPI\_FLAG\_RXNE) != RESET) && 
271         ((itsource & SPI\_IT\_RXNE) != RESET)) \{
272         \mbox{\hyperlink{group___s_d___s_p_i___functions_ga8f8403c9f68c9a623486a29cf8715fda}{sd\_spi\_rx\_isr}}(dev);
273         \textcolor{keywordflow}{return};
274     \}
275 
276     \textcolor{comment}{/*--------------------- SPI in mode Transmitter ----------------------*/}
277     \textcolor{keywordflow}{if} (((itflag & SPI\_FLAG\_TXE) != RESET) && 
278         ((itsource & SPI\_IT\_TXE) != RESET)) \{
279         spi->TxISR(spi);
280         \textcolor{keywordflow}{return};
281     \}
282 
283     \textcolor{comment}{/*-------------------- SPI in Error Treatment ------------------------*/}
284     \textcolor{keywordflow}{if} ((itflag & (SPI\_FLAG\_MODF | SPI\_FLAG\_OVR | SPI\_FLAG\_FRE)) != RESET) \{
285         \textcolor{comment}{/* SPI Overrun error interrupt occurred */}
286         \textcolor{keywordflow}{if} ((itflag & SPI\_FLAG\_OVR) != RESET) \{
287             \textcolor{keywordflow}{if} (spi->State != HAL\_SPI\_STATE\_BUSY\_TX) \{
288                 spi->ErrorCode |= HAL\_SPI\_ERROR\_OVR;
289                 \_\_HAL\_SPI\_CLEAR\_OVRFLAG(spi);
290             \} \textcolor{keywordflow}{else} \{
291                 \textcolor{keywordflow}{return};
292             \}
293         \}
294 
295         \textcolor{comment}{/* SPI Mode Fault error interrupt occurred */}
296         \textcolor{keywordflow}{if} ((itflag & SPI\_FLAG\_MODF) != RESET) \{
297             spi->ErrorCode |= HAL\_SPI\_ERROR\_MODF;
298             \_\_HAL\_SPI\_CLEAR\_MODFFLAG(spi);
299         \}
300 
301         \textcolor{comment}{/* SPI Frame error interrupt occurred */}
302         \textcolor{keywordflow}{if} ((itflag & SPI\_FLAG\_FRE) != RESET) \{
303             spi->ErrorCode |= HAL\_SPI\_ERROR\_FRE;
304             \_\_HAL\_SPI\_CLEAR\_FREFLAG(spi);
305         \}
306 
307         \_\_HAL\_SPI\_DISABLE\_IT(spi, SPI\_IT\_RXNE | SPI\_IT\_TXE | SPI\_IT\_ERR);
308         spi->State = HAL\_SPI\_STATE\_READY;
309         \mbox{\hyperlink{group___s_d___s_p_i___functions_ga3515d67aa70e65e562b55011aface3b9}{sd\_spi\_error\_cb}}(dev);
310         \textcolor{keywordflow}{return};
311     \}
312 \}
\end{DoxyCode}
\mbox{\Hypertarget{group___s_d___s_p_i___functions_gad3e4aa819e8e76a92816be83ca2702c9}\label{group___s_d___s_p_i___functions_gad3e4aa819e8e76a92816be83ca2702c9}} 
\index{S\+P\+I Functions@{S\+P\+I Functions}!sd\+\_\+spi\+\_\+rx\+\_\+init@{sd\+\_\+spi\+\_\+rx\+\_\+init}}
\index{sd\+\_\+spi\+\_\+rx\+\_\+init@{sd\+\_\+spi\+\_\+rx\+\_\+init}!S\+P\+I Functions@{S\+P\+I Functions}}
\subsubsection{\texorpdfstring{sd\+\_\+spi\+\_\+rx\+\_\+init()}{sd\_spi\_rx\_init()}}
{\footnotesize\ttfamily enum \mbox{\hyperlink{group___s_d___s_p_i___types_ga9ae67f7089a8196e9c6b74b8a6708c2e}{sd\+\_\+spi\+\_\+error}} sd\+\_\+spi\+\_\+rx\+\_\+init (\begin{DoxyParamCaption}\item[{struct \mbox{\hyperlink{structsd__spi__dev}{sd\+\_\+spi\+\_\+dev}} $\ast$}]{dev,  }\item[{struct \mbox{\hyperlink{structsd__cbuf}{sd\+\_\+cbuf}} $\ast$}]{rx\+\_\+buff }\end{DoxyParamCaption})}



{\ttfamily \#include $<$\mbox{\hyperlink{sd__spi_8c}{Src/sd\+\_\+spi.\+c}}$>$}



S\+PI Receive Interrupt Initialization Enable and prepare the S\+PI to receive on interrupt. 

\begin{DoxyNote}{Note}
This function expects that the S\+PI peripheral and the buffer have already been inititialized and are ready to be used.
\end{DoxyNote}

\begin{DoxyParams}{Parameters}
{\em dev} & Device to initialize S\+PI and buffer \\
\hline
{\em spi} & S\+PI peripheral handle \\
\hline
{\em rx\+\_\+buff} & Buffer to use for U\+A\+RT receive function \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em S\+D\+\_\+\+S\+P\+I\+\_\+\+S\+U\+C\+C\+E\+SS} & on success, error state otherwise \\
\hline
\end{DoxyRetVals}

\begin{DoxyCode}
199 \{
200     SPI\_HandleTypeDef *spi = dev->\mbox{\hyperlink{structsd__spi__dev_a06909907ded69cbc00db1f401a90f8ee}{spi}};
201 
202     \textcolor{keywordflow}{if} ((dev == NULL) || (spi == NULL))
203         \textcolor{keywordflow}{goto} error;
204                         
205     dev->\mbox{\hyperlink{structsd__spi__dev_a06909907ded69cbc00db1f401a90f8ee}{spi}} = spi;       \textcolor{comment}{/* Set the UART handle pointer */}
206        
207     \textcolor{comment}{/* Process Locked */}            
208     \textcolor{keywordflow}{if} (spi->Lock == HAL\_LOCKED)
209         \textcolor{keywordflow}{return} \mbox{\hyperlink{group___s_d___s_p_i___types_gga9ae67f7089a8196e9c6b74b8a6708c2eaa7e23f729a2493076dfb261678471c24}{SD\_SPI\_LOCKED}};
210     \textcolor{keywordflow}{else}
211         spi->Lock = HAL\_LOCKED;
212 
213     \textcolor{comment}{/* Configure communication */}
214     spi->State       = HAL\_SPI\_STATE\_BUSY\_RX;
215     spi->ErrorCode   = HAL\_SPI\_ERROR\_NONE;
216 
217 
218     \textcolor{keywordflow}{if} (spi->Init.CRCCalculation == SPI\_CRCCALCULATION\_ENABLE) \{
219         spi->CRCSize = 1;
220         \textcolor{keywordflow}{if} ((spi->Init.DataSize <= SPI\_DATASIZE\_8BIT) && (spi->Init.CRCLength == SPI\_CRC\_LENGTH\_16BIT)) \{
221             spi->CRCSize = 2;
222         \}
223     \} \textcolor{keywordflow}{else} \{
224         spi->CRCSize = 0;
225     \}
226 
227     \textcolor{comment}{/* set fiforxthresold according the reception data length: 8 bit */}
228     SET\_BIT(spi->Instance->CR2, SPI\_RXFIFO\_THRESHOLD);
229 \textcolor{comment}{//  spi->RxISR = SPI\_RxISR\_8BIT;}
230 
231     \textcolor{comment}{/* Configure communication direction : 1Line */}
232     \textcolor{keywordflow}{if} (spi->Init.Direction == SPI\_DIRECTION\_1LINE)
233         SPI\_1LINE\_RX(spi);
234 
235     \textcolor{comment}{/* Reset CRC Calculation */}
236     \textcolor{keywordflow}{if} (spi->Init.CRCCalculation == SPI\_CRCCALCULATION\_ENABLE)
237         SPI\_RESET\_CRC(spi);
238     
239 
240     \textcolor{comment}{/* Enable RXNE and ERR interrupt */}
241     \_\_HAL\_SPI\_ENABLE\_IT(spi, (SPI\_IT\_RXNE | SPI\_IT\_ERR));
242 
243     \textcolor{comment}{/* Check if the SPI is already enabled */}
244     \textcolor{keywordflow}{if} ((spi->Instance->CR1 & SPI\_CR1\_SPE) != SPI\_CR1\_SPE)
245         \_\_HAL\_SPI\_ENABLE(spi);         \textcolor{comment}{/* Enable SPI peripheral */}
246 
247     error :
248         \textcolor{comment}{/* Process Unlocked */}
249         \_\_HAL\_UNLOCK(spi);
250         \textcolor{keywordflow}{return} \mbox{\hyperlink{group___s_d___s_p_i___types_gga9ae67f7089a8196e9c6b74b8a6708c2eae8bfc341906b1dcb2431a61007acd4f0}{SD\_SPI\_ERROR}};
251 \}
\end{DoxyCode}
\mbox{\Hypertarget{group___s_d___s_p_i___functions_ga8f8403c9f68c9a623486a29cf8715fda}\label{group___s_d___s_p_i___functions_ga8f8403c9f68c9a623486a29cf8715fda}} 
\index{S\+P\+I Functions@{S\+P\+I Functions}!sd\+\_\+spi\+\_\+rx\+\_\+isr@{sd\+\_\+spi\+\_\+rx\+\_\+isr}}
\index{sd\+\_\+spi\+\_\+rx\+\_\+isr@{sd\+\_\+spi\+\_\+rx\+\_\+isr}!S\+P\+I Functions@{S\+P\+I Functions}}
\subsubsection{\texorpdfstring{sd\+\_\+spi\+\_\+rx\+\_\+isr()}{sd\_spi\_rx\_isr()}}
{\footnotesize\ttfamily enum \mbox{\hyperlink{group___s_d___s_p_i___types_ga9ae67f7089a8196e9c6b74b8a6708c2e}{sd\+\_\+spi\+\_\+error}} sd\+\_\+spi\+\_\+rx\+\_\+isr (\begin{DoxyParamCaption}\item[{struct \mbox{\hyperlink{structsd__spi__dev}{sd\+\_\+spi\+\_\+dev}} $\ast$}]{dev }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



{\ttfamily \#include $<$\mbox{\hyperlink{sd__spi_8c}{Src/sd\+\_\+spi.\+c}}$>$}



Receive an amount of data in interrupt mode. 


\begin{DoxyParams}{Parameters}
{\em spi\+\_\+dev} & The S\+PI peripheral that triggered interrupt \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em S\+D\+\_\+\+S\+P\+I\+\_\+\+S\+U\+C\+C\+E\+SS} & on success, error status otherwise \\
\hline
\end{DoxyRetVals}
\begin{DoxyRefDesc}{Todo}
\item[\mbox{\hyperlink{todo__todo000002}{Todo}}]Determine where to put the collected data based on the first two bytes (register and packet length) and point to the peripheral that matches the the register. \end{DoxyRefDesc}

\begin{DoxyCode}
322 \{
323     \textcolor{keyword}{struct }\mbox{\hyperlink{structsd__cbuf}{sd\_cbuf}} *rx\_buff = dev->\mbox{\hyperlink{structsd__spi__dev_a2bc17c33f4234299b83ba5d98edd5887}{rx\_buff}};
324     SPI\_HandleTypeDef *spi = dev->\mbox{\hyperlink{structsd__spi__dev_a06909907ded69cbc00db1f401a90f8ee}{spi}};
325     uint8\_t c;
326     
327     rx\_buff->\mbox{\hyperlink{structsd__cbuf_a8b212742c92a124f2eb4a244acc19f7c}{buff}}[rx\_buff->\mbox{\hyperlink{structsd__cbuf_a86fd6c417fa43c58339f7cde29495419}{in}}++] = (uint8\_t)spi->Instance->DR;
328     
329     if (rx\_buff->\mbox{\hyperlink{structsd__cbuf_a86fd6c417fa43c58339f7cde29495419}{in}} >= rx\_buff->\mbox{\hyperlink{structsd__cbuf_ab2c6b258f02add8fdf4cfc7c371dd772}{size}})
330         rx\_buff->\mbox{\hyperlink{structsd__cbuf_a86fd6c417fa43c58339f7cde29495419}{in}} = 0;
331     
332     \textcolor{keywordflow}{switch} (dev->\mbox{\hyperlink{structsd__spi__dev_a7488772254dfa2b24612698ff20d2db5}{rx\_state}}) \{
333     \textcolor{keywordflow}{case} \mbox{\hyperlink{group___s_d___s_p_i___types_gga0cf86b44c1bee9173f49395d05e076d5a18932b80de20adc5422578c1512c5f6d}{SD\_SPI\_RX\_WAITING}}:
334     \textcolor{comment}{/*}
335 \textcolor{comment}{     * Use the received byte to point to the corresponding}
336 \textcolor{comment}{     * peripheral/interface.}
337 \textcolor{comment}{     */}
338         dev->\mbox{\hyperlink{structsd__spi__dev_a1dcf429d8ce65a6c37d9e20c41143afe}{pkt}}->\mbox{\hyperlink{structsd__spi__packet_a85ae3ea863487ba420db83e0338c4e12}{hdr}} = c;
339         dev->\mbox{\hyperlink{structsd__spi__dev_a7488772254dfa2b24612698ff20d2db5}{rx\_state}} = \mbox{\hyperlink{group___s_d___s_p_i___types_gga0cf86b44c1bee9173f49395d05e076d5a3d56ab099b151c3b01757f4a1c8bfc0f}{SD\_SPI\_RX\_LENGTH}};
340         \textcolor{keywordflow}{break};
341     
342     \textcolor{keywordflow}{case} \mbox{\hyperlink{group___s_d___s_p_i___types_gga0cf86b44c1bee9173f49395d05e076d5a3d56ab099b151c3b01757f4a1c8bfc0f}{SD\_SPI\_RX\_LENGTH}}:
343         \textcolor{comment}{/*}
344 \textcolor{comment}{     * Use the received byte to determine the length of the packet}
345 \textcolor{comment}{     * message that is to be received.}
346 \textcolor{comment}{     */}
347         dev->\mbox{\hyperlink{structsd__spi__dev_a1dcf429d8ce65a6c37d9e20c41143afe}{pkt}}->\mbox{\hyperlink{structsd__spi__packet_a5723e60ffd628510c699eddbce90be23}{len}} = c;
348         dev->\mbox{\hyperlink{structsd__spi__dev_a1dcf429d8ce65a6c37d9e20c41143afe}{pkt}}->\mbox{\hyperlink{structsd__spi__packet_a9aacead5af8fd516f2301fe34ff50c29}{pload}} = &spi\_pkt\_buff[0];
349         dev->\mbox{\hyperlink{structsd__spi__dev_a7488772254dfa2b24612698ff20d2db5}{rx\_state}} = \mbox{\hyperlink{group___s_d___s_p_i___types_gga0cf86b44c1bee9173f49395d05e076d5aad68b7ce311a7ca2b9a5546e8c6767fd}{SD\_SPI\_RX\_PACKET}};
350         \textcolor{keywordflow}{break};
351         
352     \textcolor{keywordflow}{case} \mbox{\hyperlink{group___s_d___s_p_i___types_gga0cf86b44c1bee9173f49395d05e076d5aad68b7ce311a7ca2b9a5546e8c6767fd}{SD\_SPI\_RX\_PACKET}}:
353         \textcolor{comment}{/* In the process of receiving a packet. */}
354         *(dev->\mbox{\hyperlink{structsd__spi__dev_a1dcf429d8ce65a6c37d9e20c41143afe}{pkt}}->\mbox{\hyperlink{structsd__spi__packet_a9aacead5af8fd516f2301fe34ff50c29}{pload}}++) = c;
355         \textcolor{keywordflow}{if} (--dev->\mbox{\hyperlink{structsd__spi__dev_a1dcf429d8ce65a6c37d9e20c41143afe}{pkt}}->\mbox{\hyperlink{structsd__spi__packet_a5723e60ffd628510c699eddbce90be23}{len}} == 0) \{
356             \textcolor{comment}{/* Retransmit the buffer */}
357             dev->\mbox{\hyperlink{structsd__spi__dev_a1dcf429d8ce65a6c37d9e20c41143afe}{pkt}}->\mbox{\hyperlink{structsd__spi__packet_a9aacead5af8fd516f2301fe34ff50c29}{pload}} = &spi\_pkt\_buff[0];
358             \textcolor{comment}{/* sd\_spi\_bridge(dev); */}
359             dev->\mbox{\hyperlink{structsd__spi__dev_a7488772254dfa2b24612698ff20d2db5}{rx\_state}} = \mbox{\hyperlink{group___s_d___s_p_i___types_gga0cf86b44c1bee9173f49395d05e076d5a18932b80de20adc5422578c1512c5f6d}{SD\_SPI\_RX\_WAITING}};
360         \}
361         \textcolor{keywordflow}{break};
362     \}
363     
364         
370     
371 \textcolor{comment}{//  if (sd\_char\_buff\_putc\_to(rx\_buff, c, 100) == SD\_BUFF\_SUCCESS)}
372         \textcolor{keywordflow}{return} \mbox{\hyperlink{group___s_d___s_p_i___types_gga9ae67f7089a8196e9c6b74b8a6708c2ea109567296b93a03b1949407009750681}{SD\_SPI\_SUCCESS}};
373 \textcolor{comment}{//  else}
374 \textcolor{comment}{//      return SD\_SPI\_ERROR;    }
375 \}
\end{DoxyCode}
